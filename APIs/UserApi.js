import exp from "express";
import { authenticate, register } from "../Services/authService.js";
import { ArticleModel } from "../models/ArticleModel.js";
import { verifyToken } from "../middlewares/verifyToken.js";
export const userRoute=exp.Router()

//Register user
userRoute.post('/users',async(req,res)=>{
    //get user obj from req
    let userObj=req.body;
    //call register
    const newUserObj=await register({...userObj,role:"USER"})
    //send res
    res.status(201).json({message:"User created",payload:newUserObj})
});

//Authenticate user


//Read all articles

userRoute.get('/articles',verifyToken,async(req,res)=>{
    let articles=await ArticleModel.find()
    res.status(200).json({message:"Articles",payload:articles})
})

//Add comment to an article

userRoute.post('/articles/:articleId',async(req,res)=>{
    const { articleId } = req.params
    let {comment}=req.body
    let articleOfDB=await ArticleModel.findOne({_id:articleId})
    if(!articleOfDB){
        return res.status(404).json({message:"Article not found"})
    }
    //update the article
    let updatedArticle=await ArticleModel.findByIdAndUpdate(articleId,
        {$push:{ comments:{comment: comment }}},
        { new:true});
        //send res(updated article)
     res.status(200).json({message:"Article updated",payload:updatedArticle})
})